name: "Generate Coverage Report"
on:
  push:
    branches:
      - '*'
  # S'ex√©cute apr√®s le workflow principal de build
  workflow_run:
    workflows: [ "Build and Test" ]
    types:
      - completed

jobs:
  coverage-report:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Log Message
        run: |
          echo "Processing JaCoCo Coverage Report..."
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Download Build Artifact
        uses: actions/download-artifact@v3
        with:
          name: maven-artifact
          path: ./target

      - name: Generate Coverage Report
        run: |
          mkdir -p .github/test-coverage

          # Extraire les m√©triques du fichier JaCoCo
          GLOBAL_COVERAGE=$(cat jacoco-report/index.html | grep -o 'Total[^%]*%' | grep -o '[0-9]*%' | head -1)
          LINE_COVERAGE=$(cat jacoco-report/index.html | grep -o 'Lines[^%]*%' | grep -o '[0-9]*%' | head -1)
          BRANCH_COVERAGE=$(cat jacoco-report/index.html | grep -o 'Branches[^%]*%' | grep -o '[0-9]*%' | head -1)

          # Cr√©er un rapport de couverture en Markdown
          cat << EOF > .github/test-coverage/coverage.md
          # üìä Rapport de Couverture des Tests

          ## Vue d'ensemble
          
          | M√©trique            | Couverture | Statut |
          |---------------------|------------|--------|
          | Couverture Globale  | $GLOBAL_COVERAGE | $([ "${GLOBAL_COVERAGE//%/}" -ge 80 ] && echo "‚úÖ" || echo "‚ùå") |
          | Lignes de Code      | $LINE_COVERAGE | $([ "${LINE_COVERAGE//%/}" -ge 80 ] && echo "‚úÖ" || echo "‚ùå") |
          | Branches            | $BRANCH_COVERAGE | $([ "${BRANCH_COVERAGE//%/}" -ge 80 ] && echo "‚úÖ" || echo "‚ùå") |

          ## üìà D√©tails par Package

          Les packages les plus importants :
          $(awk -F',' 'NR>1 {print "- " $2 ": " $8 "% couverture"}' jacoco-report/jacoco.csv | head -5)

          ## ‚ÑπÔ∏è Informations
          - Derni√®re mise √† jour : $(date '+%Y-%m-%d %H:%M:%S')
          - Seuil minimal : 80%
          - [Voir le rapport complet](../jacoco-report/index.html)

          EOF

      - name: Commit Report
        uses: EndBug/add-and-commit@v9
        with:
          default_author: github_actions
          message: 'Mise √† jour du rapport de couverture'
          add: '.github/test-coverage/*'
